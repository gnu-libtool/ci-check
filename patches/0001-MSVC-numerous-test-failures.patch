From c170c41062518a5f5f0c4c16feda6cdc07010c75 Mon Sep 17 00:00:00 2001
From: Ileana Dumitrescu <ileanadumitrescu95@gmail.com>
Date: Wed, 11 Dec 2024 18:43:47 +0200
Subject: [PATCH] MSVC: numerous test failures

---
diff --git a/tests/f77demo.at b/tests/f77demo.at
index 6b96920a..07a619e6 100644
--- a/tests/f77demo.at
+++ b/tests/f77demo.at
@@ -300,6 +300,9 @@ then
   AT_CHECK([echo "$LDFLAGS" | $EGREP 'fsanitize=' && (exit 77)], 1)
 fi
 
+# Skip Fortran tests for MSVC toolchain
+AT_CHECK([$LIBTOOL --config | $EGREP '^nm_interface="MS dumpbin"' && (exit 77)], 1)
+
 # Executing the static fprogram might be interactive on MSYS.
 AT_KEYWORDS([interactive])
 
@@ -326,6 +329,9 @@ then
   AT_CHECK([echo "$LDFLAGS" | $EGREP 'fsanitize=' && (exit 77)], 1)
 fi
 
+# Skip Fortran tests for MSVC toolchain
+AT_CHECK([$LIBTOOL --config | $EGREP '^nm_interface="MS dumpbin"' && (exit 77)], 1)
+
 _LT_SETUP
 
 LT_AT_CHECK_CONFIG([--disable-static],
@@ -349,6 +355,9 @@ then
   AT_CHECK([echo "$LDFLAGS" | $EGREP 'fsanitize=' && (exit 77)], 1)
 fi
 
+# Skip Fortran tests for MSVC toolchain
+AT_CHECK([$LIBTOOL --config | $EGREP '^nm_interface="MS dumpbin"' && (exit 77)], 1)
+
 _LT_SETUP
 
 LT_AT_CHECK_CONFIG([],
diff --git a/tests/fcdemo.at b/tests/fcdemo.at
index 80fe2482..9d934045 100644
--- a/tests/fcdemo.at
+++ b/tests/fcdemo.at
@@ -314,6 +314,9 @@ then
   AT_CHECK([echo "$LDFLAGS" | $EGREP 'fsanitize=' && (exit 77)], 1)
 fi
 
+# Skip Fortran tests for MSVC toolchain
+AT_CHECK([$LIBTOOL --config | $EGREP '^nm_interface="MS dumpbin"' && (exit 77)], 1)
+
 # Executing the static fprogram might be interactive on MSYS.
 AT_KEYWORDS([interactive])
 
@@ -340,6 +343,9 @@ then
   AT_CHECK([echo "$LDFLAGS" | $EGREP 'fsanitize=' && (exit 77)], 1)
 fi
 
+# Skip Fortran tests for MSVC toolchain
+AT_CHECK([$LIBTOOL --config | $EGREP '^nm_interface="MS dumpbin"' && (exit 77)], 1)
+
 _LT_SETUP
 
 LT_AT_CHECK_CONFIG([--disable-static],
@@ -363,6 +369,9 @@ then
   AT_CHECK([echo "$LDFLAGS" | $EGREP 'fsanitize=' && (exit 77)], 1)
 fi
 
+# Skip Fortran tests for MSVC toolchain
+AT_CHECK([$LIBTOOL --config | $EGREP '^nm_interface="MS dumpbin"' && (exit 77)], 1)
+
 _LT_SETUP
 
 LT_AT_CHECK_CONFIG([],
diff --git a/libtoolize.in b/libtoolize.in
index 6c15aa57..46be8c1b 100644
--- a/libtoolize.in
+++ b/libtoolize.in
@@ -439,6 +439,24 @@ func_copy ()
       my_copy_type=linking
     fi
     my_copy_msg="$my_copy_type file '$my_destfile'"
+
+    # The Windows linker, mklink, swaps link_name and target.
+    case $my_copycmd in
+    *mklink*)
+      my_temp=$my_destfile
+      my_destfile=$my_srcfile
+      my_srcfile=$my_temp
+
+      my_destfile=`cygpath -aw "$my_destfile"`
+      my_srcfile=`cygpath -aw "$my_srcfile"`
+
+      if test -d "$my_destfile"; then
+        my_copycmd="$my_copycmd /d"
+      fi
+    ;;
+    *) ;;
+    esac
+
     $opt_verbose && my_copy_msg="$my_copycmd $my_srcfile $my_destdir"
 
     if $opt_dry_run || $my_copycmd "$my_srcfile" "$my_destfile" 2>/dev/null
diff --git a/tests/demo.at b/tests/demo.at
index a506a93e..eb97fc24 100644
--- a/tests/demo.at
+++ b/tests/demo.at
@@ -152,7 +152,7 @@ AT_DATA([foo.h],
 #  endif
 #endif
 
-#if (defined _WIN32 || defined _WIN32_WCE) && !defined __GNUC__
+#if (defined _WIN32 || defined _WIN32_WCE || __CYGWIN__) && !defined __GNUC__
 # ifdef BUILDING_LIBHELLO
 #  ifdef DLL_EXPORT
 #   define LIBHELLO_SCOPE extern __declspec (dllexport)
diff --git a/tests/lt_dlexit.at b/tests/lt_dlexit.at
index f2b4e2f7..1bbb73db 100644
--- a/tests/lt_dlexit.at
+++ b/tests/lt_dlexit.at
@@ -115,8 +115,12 @@ AT_DATA([b1.c],
 [[#ifdef __cplusplus
 extern "C" {
 #endif
-#if defined DLL_EXPORT && defined _WIN32 && defined _MSC_VER
-#  define LIBA1_SCOPE extern __declspec (dllimport)
+#if defined DLL_EXPORT
+#  if defined __CYGWIN__ || defined _WIN32 || defined WIN32
+#    if defined _MSC_VER
+#      define LIBA1_SCOPE extern __declspec (dllimport)
+#    endif
+#  endif
 #endif
 #if !defined LIBA1_SCOPE
 #  define LIBA1_SCOPE extern
diff --git a/tests/testsuite.at b/tests/testsuite.at
index bacc72ce..5a3e4372 100644
--- a/tests/testsuite.at
+++ b/tests/testsuite.at
@@ -72,6 +72,11 @@ unset MFLAGS MAKEFLAGS MAKELEVEL __MKLVL__ MAKE_JOBS_FIFO
 case $host_os in
 aix*) umask o-rwx ;;
 esac
+
+# Use mklink when symlinking for MSVC
+if $LIBTOOL --config | $EGREP '^nm_interface="MS dumpbin"'; then
+LN_S="cmd /c mklink"
+fi
 m4_divert_pop([PREPARE_TESTS])dnl
 
 
-- 
2.45.2

